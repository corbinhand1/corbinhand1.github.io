<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cue to Cue - Offline Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        
        .test-section h3 {
            color: #555;
            margin-bottom: 15px;
        }
        
        .button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .button:hover {
            background: #0056CC;
        }
        
        .button.danger {
            background: #FF3B30;
        }
        
        .button.danger:hover {
            background: #CC2E26;
        }
        
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.info { color: #007AFF; }
        .log-entry.success { color: #28a745; }
        .log-entry.warning { color: #ffc107; }
        .log-entry.error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± Cue to Cue - Offline Functionality Test</h1>
        
        <div class="test-section">
            <h3>üåê Connection Status</h3>
            <div id="connectionStatus" class="status">
                Checking connection...
            </div>
            <p>Current status: <span id="statusText">Unknown</span></p>
        </div>
        
        <div class="test-section">
            <h3>üß™ Offline Testing</h3>
            <p>Use these buttons to test offline functionality:</p>
            <button class="button" onclick="testOfflineMode()">üì± Enable Offline Mode</button>
            <button class="button" onclick="testOnlineMode()">üåê Enable Online Mode</button>
            <button class="button" onclick="clearOfflineData()">üóëÔ∏è Clear Offline Data</button>
            <button class="button" onclick="refreshPage()">üîÑ Refresh Page</button>
        </div>
        
        <div class="test-section">
            <h3>üíæ Offline Storage</h3>
            <p>Storage status: <span id="storageStatus">Checking...</span></p>
            <button class="button" onclick="checkOfflineStorage()">üîç Check Storage</button>
            <button class="button" onclick="saveTestData()">üíæ Save Test Data</button>
        </div>
        
        <div class="test-section">
            <h3>üìä Service Worker</h3>
            <p>Service Worker status: <span id="swStatus">Checking...</span></p>
            <button class="button" onclick="registerServiceWorker()">üîß Register SW</button>
            <button class="button" onclick="unregisterServiceWorker()">‚ùå Unregister SW</button>
        </div>
        
        <div class="test-section">
            <h3>üìù Activity Log</h3>
            <div id="activityLog" class="log">
                <div class="log-entry info">System initialized...</div>
            </div>
            <button class="button" onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>
    </div>
    
    <script>
        // Activity logging
        function log(message, type = 'info') {
            const logDiv = document.getElementById('activityLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // Connection status management
        function updateConnectionStatus() {
            const statusDiv = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            if (navigator.onLine) {
                statusDiv.className = 'status online';
                statusDiv.textContent = 'üåê Online';
                statusText.textContent = 'Connected to the internet';
            } else {
                statusDiv.className = 'status offline';
                statusDiv.textContent = 'üì± Offline';
                statusText.textContent = 'No internet connection';
            }
        }
        
        // Offline mode testing
        function testOfflineMode() {
            log('Testing offline mode...', 'info');
            
            // Simulate going offline
            if (window.offlineIntegration) {
                window.offlineIntegration.enableOfflineMode();
                log('Offline mode enabled via integration', 'success');
            } else {
                log('Offline integration not available', 'warning');
            }
            
            // Test offline functionality
            testOfflineFunctionality();
        }
        
        function testOnlineMode() {
            log('Testing online mode...', 'info');
            
            if (window.offlineIntegration) {
                window.offlineIntegration.disableOfflineMode();
                log('Online mode enabled via integration', 'success');
            } else {
                log('Offline integration not available', 'warning');
            }
        }
        
        function testOfflineFunctionality() {
            log('Testing offline functionality...', 'info');
            
            // Try to fetch data
            fetch('/cues')
                .then(response => {
                    if (response.ok) {
                        log('Fetch successful - online', 'success');
                    } else {
                        log('Fetch failed with status: ' + response.status, 'warning');
                    }
                })
                .catch(error => {
                    log('Fetch failed - likely offline: ' + error.message, 'info');
                });
        }
        
        // Offline storage testing
        function checkOfflineStorage() {
            log('Checking offline storage...', 'info');
            
            const statusSpan = document.getElementById('storageStatus');
            
            // Check localStorage
            try {
                const localData = localStorage.getItem('cueToCueOfflineState');
                if (localData) {
                    const data = JSON.parse(localData);
                    const age = new Date().toLocaleString();
                    log(`localStorage: Found data from ${age}`, 'success');
                    statusSpan.textContent = `localStorage: ${age}`;
                } else {
                    log('localStorage: No data found', 'warning');
                    statusSpan.textContent = 'localStorage: No data';
                }
            } catch (error) {
                log('localStorage: Error checking data', 'error');
                statusSpan.textContent = 'localStorage: Error';
            }
            
            // Check IndexedDB
            if ('indexedDB' in window) {
                const dbName = 'CueToCueOffline';
                const request = indexedDB.open(dbName, 1);
                
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    if (db.objectStoreNames.contains('cueStacks')) {
                        const transaction = db.transaction(['cueStacks'], 'readonly');
                        const store = transaction.objectStore('cueStacks');
                        const countRequest = store.count();
                        
                        countRequest.onsuccess = function() {
                            log(`IndexedDB: Found ${countRequest.result} cue stacks`, 'success');
                        };
                    } else {
                        log('IndexedDB: No cue stacks store found', 'warning');
                    }
                };
                
                request.onerror = function() {
                    log('IndexedDB: Error opening database', 'error');
                };
            } else {
                log('IndexedDB: Not supported', 'warning');
            }
        }
        
        function saveTestData() {
            log('Saving test data...', 'info');
            
            const testData = {
                timestamp: Date.now(),
                test: true,
                message: 'This is test data for offline functionality',
                cueStacks: [
                    {
                        name: 'Test Cue Stack',
                        columns: [
                            { name: 'Cue', width: 100 },
                            { name: 'Description', width: 200 }
                        ],
                        cues: [
                            { values: ['1', 'Test cue 1'], timerValue: 0, isStruckThrough: false },
                            { values: ['2', 'Test cue 2'], timerValue: 0, isStruckThrough: false }
                        ]
                    }
                ],
                highlightColors: [
                    { keyword: 'test', color: '#FF0000' },
                    { keyword: 'demo', color: '#00FF00' }
                ]
            };
            
            try {
                localStorage.setItem('cueToCueOfflineState', JSON.stringify(testData));
                log('Test data saved to localStorage', 'success');
                
                // Also save to IndexedDB if available
                if (window.offlineDataManager) {
                    window.offlineDataManager.saveCueStacks(testData.cueStacks);
                    window.offlineDataManager.saveHighlightColors(testData.highlightColors);
                    log('Test data saved to IndexedDB', 'success');
                }
                
            } catch (error) {
                log('Failed to save test data: ' + error.message, 'error');
            }
        }
        
        // Service Worker testing
        function registerServiceWorker() {
            log('Registering service worker...', 'info');
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/offline-service-worker.js')
                    .then(registration => {
                        log('Service Worker registered successfully', 'success');
                        updateServiceWorkerStatus();
                    })
                    .catch(error => {
                        log('Service Worker registration failed: ' + error.message, 'error');
                    });
            } else {
                log('Service Worker not supported', 'warning');
            }
        }
        
        function unregisterServiceWorker() {
            log('Unregistering service worker...', 'info');
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    for (let registration of registrations) {
                        registration.unregister();
                        log('Service Worker unregistered', 'success');
                    }
                    updateServiceWorkerStatus();
                });
            }
        }
        
        function updateServiceWorkerStatus() {
            const statusSpan = document.getElementById('swStatus');
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    if (registrations.length > 0) {
                        statusSpan.textContent = `Registered (${registrations.length})`;
                        log(`Service Worker status: ${registrations.length} registered`, 'success');
                    } else {
                        statusSpan.textContent = 'Not registered';
                        log('Service Worker status: Not registered', 'warning');
                    }
                });
            } else {
                statusSpan.textContent = 'Not supported';
                log('Service Worker status: Not supported', 'warning');
            }
        }
        
        // Utility functions
        function clearOfflineData() {
            log('Clearing offline data...', 'info');
            
            try {
                localStorage.removeItem('cueToCueOfflineState');
                localStorage.removeItem('cueToCueAppState');
                log('localStorage cleared', 'success');
                
                if (window.offlineIntegration && window.offlineIntegration.offlineDataManager) {
                    // Clear IndexedDB
                    const dbName = 'CueToCueOffline';
                    const request = indexedDB.open(dbName, 1);
                    
                    request.onsuccess = function(event) {
                        const db = event.target.result;
                        if (db.objectStoreNames.contains('cueStacks')) {
                            const transaction = db.transaction(['cueStacks'], 'readwrite');
                            const store = transaction.objectStore('cueStacks');
                            store.clear();
                            log('IndexedDB cue stacks cleared', 'success');
                        }
                        if (db.objectStoreNames.contains('highlightColors')) {
                            const transaction = db.transaction(['highlightColors'], 'readwrite');
                            const store = transaction.objectStore('highlightColors');
                            store.clear();
                            log('IndexedDB highlight colors cleared', 'success');
                        }
                    };
                }
                
                checkOfflineStorage();
                
            } catch (error) {
                log('Failed to clear offline data: ' + error.message, 'error');
            }
        }
        
        function refreshPage() {
            log('Refreshing page...', 'info');
            window.location.reload();
        }
        
        function clearLog() {
            const logDiv = document.getElementById('activityLog');
            logDiv.innerHTML = '<div class="log-entry info">Log cleared...</div>';
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('Offline test page loaded', 'success');
            
            // Set up event listeners
            window.addEventListener('online', () => {
                updateConnectionStatus();
                log('Connection restored', 'success');
            });
            
            window.addEventListener('offline', () => {
                updateConnectionStatus();
                log('Connection lost', 'warning');
            });
            
            // Initial status checks
            updateConnectionStatus();
            updateServiceWorkerStatus();
            checkOfflineStorage();
            
            // Check for offline integration
            setTimeout(() => {
                if (window.offlineIntegration) {
                    log('Offline integration detected', 'success');
                } else {
                    log('Offline integration not detected', 'warning');
                }
            }, 1000);
        });
    </script>
</body>
</html>
